<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SportBuddy - Запись на игру</title>
    <link rel="stylesheet" href="/style/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;900&display=swap" rel="stylesheet">
</head>

<body>
<div class="container">
    <h1 class="title">SportBuddy</h1>
    <p class="subtitle">Найди команду для игры быстро и удобно!</p>

    <div class="card">
        <h2 class="card-title">Выберите игру</h2>

        <!-- Шаг 1: Выбор вида спорта -->
        <div class="form-group">
            <label for="sportType">Вид спорта:</label>
            <select id="sportType" name="sportType" class="form-select">
                <option value="" selected disabled hidden>Выберите вид спорта</option>
                <option th:each="sportType : ${sportTypes}"
                        th:value="${sportType.id}"
                        th:text="${sportType.name}"></option>
            </select>
        </div>

        <!-- Шаг 2: Выбор площадки -->
        <div id="courtSection" style="display: none;">
            <div class="form-group">
                <label for="court">Площадка:</label>
                <select id="court" name="court" class="form-select">
                    <option value="" selected disabled hidden>Выберите площадку</option>
                </select>
            </div>
        </div>
        
        <!-- Шаг 3: Выбор времени -->
        <div id="timeSection" style="display: none;">
            <div class="form-group">
                <label>Доступное время:</label>
                <div id="dayTabs" class="day-tabs"></div>
                <div id="timePills" class="time-pills"></div>
            </div>
        </div>


        <!-- Кнопки -->
        <div class="dashboard-actions">
            <a href="/dashboard" class="cta-button" style="background: #6c5ce7;">В кабинет</a>
        </div>
    </div>
</div>

<script>
  const sportSelect = document.getElementById('sportType');
  const courtSelect = document.getElementById('court');

  const courtSection = document.getElementById('courtSection');
  const timeSection = document.getElementById('timeSection');

  const dayTabs = document.getElementById('dayTabs');
  const timePills = document.getElementById('timePills');

  const MAX_PLAYERS = 20;

  function resetTimeUI() {
    timeSection.style.display = 'none';
    dayTabs.innerHTML = '';
    timePills.innerHTML = '';
  }

  function resetCourtUI() {
    courtSection.style.display = 'none';
    courtSelect.innerHTML = '<option value="" selected disabled hidden>Выберите площадку</option>';
  }

  // Когда выбирают вид спорта
  sportSelect.addEventListener('change', function () {
    const sportTypeId = this.value;

    resetTimeUI();
    resetCourtUI();

    if (!sportTypeId) return;

    fetch('/court/courts/' + sportTypeId)
      .then(r => r.json())
      .then(courts => {
        courtSelect.innerHTML = '<option value="" selected disabled hidden>Выберите площадку</option>';

        courts.forEach(court => {
          const opt = document.createElement('option');
          opt.value = court.id;
          opt.textContent = court.name;
          courtSelect.appendChild(opt);
        });

        courtSection.style.display = 'block';
      })
      .catch(() => {
        alert('Не удалось загрузить площадки');
      });
  });

  // Когда выбирают площадку
  courtSelect.addEventListener('change', function () {
    const courtId = this.value;

    resetTimeUI();
    if (!courtId) return;

    fetch('/court/timeslots/' + courtId)
      .then(r => r.json())
      .then(timeSlots => {
        const slotsByDayAll = groupTimeSlotsByDay(timeSlots);

        // только 3 дня вперёд (первые 3 ключа)
        const days = Object.keys(slotsByDayAll).slice(0, 3);

        dayTabs.innerHTML = '';
        timePills.innerHTML = '';

        if (days.length === 0) {
          timePills.innerHTML = '<div style="padding:10px; font-weight:700;">Нет доступного времени</div>';
          timeSection.style.display = 'block';
          return;
        }

        // вкладки дней
        days.forEach((day, idx) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'day-tab' + (idx === 0 ? ' active' : '');
          btn.textContent = day;

          btn.onclick = () => {
            document.querySelectorAll('.day-tab').forEach(x => x.classList.remove('active'));
            btn.classList.add('active');
            renderDay(day, slotsByDayAll);
          };

          dayTabs.appendChild(btn);
        });

        // показываем первый день
        renderDay(days[0], slotsByDayAll);

        timeSection.style.display = 'block';
      })
      .catch(() => {
        alert('Не удалось загрузить время');
      });
  });

  function renderDay(day, slotsByDayAll) {
    timePills.innerHTML = '';

    const slots = slotsByDayAll[day] || [];

    slots.forEach(slot => {
      const startTime = formatTime(slot.startTime);
      const endTime = formatTime(slot.endTime);

      const pill = document.createElement('button');
      pill.type = 'button';
      pill.className = 'time-pill';

      pill.innerHTML = `
        <div class="t">${startTime} – ${endTime}</div>
        <div class="s">Бесплатно • 0/${MAX_PLAYERS}</div>
      `;


      pill.onclick = () => bookTimeSlot(slot.id);
      timePills.appendChild(pill);

      // подтягиваем реальное число участников
      fetch('/court/booking-count/' + slot.id)
        .then(r => r.json())
        .then(count => {
          pill.innerHTML = `
            <div class="t">${startTime} – ${endTime}</div>
            <div class="s">Бесплатно • ${count}/${MAX_PLAYERS}</div>
          `;


          if (count >= MAX_PLAYERS) {
            pill.classList.add('full');
            pill.onclick = null;
          }
        })
        .catch(() => {
          // если не удалось получить count — оставляем как есть
        });
    });
  }

  function groupTimeSlotsByDay(timeSlots) {
    const groups = {};

    timeSlots.forEach(slot => {
      const date = new Date(slot.startTime);

      const day = date.toLocaleDateString('ru-RU', { weekday: 'short' }); // Вс
      const dayFixed = day.charAt(0).toUpperCase() + day.slice(1, 2);     // Вс
      const dayNum = date.getDate();                                      // 18
      const month = date.toLocaleDateString('ru-RU', { month: 'short' }); // янв

      const label = `${dayFixed}, ${dayNum} ${month}`;

      if (!groups[label]) groups[label] = [];
      groups[label].push(slot);
    });

    return groups;
  }

  function formatTime(dateTimeString) {
    const date = new Date(dateTimeString);
    return date.toLocaleTimeString('ru-RU', {
      hour: '2-digit',
      minute: '2-digit',
      timeZone: 'Europe/Saratov'
    });
  }

  function bookTimeSlot(timeSlotId) {
    if (confirm('Записаться на это время?')) {
      fetch('/court/book', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'timeSlotId=' + encodeURIComponent(timeSlotId)
      })
      .then(response => {
        if (response.ok) {
          window.location.href = '/court/participants/' + timeSlotId;
        } else {
          alert('Ошибка записи');
        }
      })
      .catch(() => alert('Ошибка сети'));
    }
  }
</script>


</body>
</html>
